name: Pull Request Open - Slack notifications
on:
  push:
  pull_request:
    types: [opened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MSG_SEPERATOR: "::::: DO NOT EDIT BELOW :::::"

jobs:

  pr_notifications:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code.
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      # Debugger
      - uses: hmarr/debug-action@v3


      # Setup and cache node.
      - name: Use Node.js with proper version.
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      # Install core actions to set output variables.
      - name: Install dependencies
        run: npm install @actions/core

      # Cache vendor folder
      - name: Cache vendor folder
        uses: actions/cache@v4
        env:
          cache-name: cache-vendor
        with:
          path: ./vendor
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}

      # Debugger
      - uses: hmarr/debug-action@v3

      - name: run node script
        id: process-body
        env:
          CONTEXT_GITHUB: ${{ toJson(github) }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_ACTION: ${{ github.event.action }}
        run: node ./.ci/scripts/pr-notifications.js

      - name: Use the output variable
        run: |
          echo "The output is ${{ steps.process-body.outputs.myOutput }}"
          echo "The output is ${{ steps.process-body.outputs.slack_payload }}"
          echo "The output is ${{ steps.process-body.outputs.pr_description }}"
          echo "The output is ${{ steps.process-body.outputs.pr_description_data }}"

      # Debugger
      - uses: hmarr/debug-action@v3



# Open Pr:
#   I need to post a message to slack and save the message ID on the PR description.
# PR #123 opened by @pingevt
# Reopen Pr:
#   start new message in slack.
# Close Pr:
